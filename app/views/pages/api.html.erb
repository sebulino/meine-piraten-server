<h1>API Documentation</h1>

<h2>General</h2>
<ul>
  <li><strong>Base URL:</strong> <code>https://meine-piraten.de</code></li>
  <li><strong>Format:</strong> JSON &mdash; append <code>.json</code> to any endpoint or send <code>Accept: application/json</code></li>
</ul>

<hr>

<h2>Authentication</h2>
<p>All API endpoints require authentication via a <strong>Bearer token</strong> (JWT) issued by PiratenSSO (Keycloak).</p>

<h3>Obtaining a token</h3>
<p>Request an access token from the PiratenSSO token endpoint using the OAuth 2.0 authorization code flow or client credentials:</p>
<pre><code>POST https://sso.piratenpartei.de/realms/Piratenlogin/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id=YOUR_CLIENT_ID
&client_secret=YOUR_CLIENT_SECRET</code></pre>

<p>The response contains an <code>access_token</code>:</p>
<pre><code>{
  "access_token": "eyJhbGciOiJSUzI1NiIs...",
  "expires_in": 300,
  "token_type": "Bearer"
}</code></pre>

<h3>Using the token</h3>
<p>Include the token in the <code>Authorization</code> header of every API request:</p>
<pre><code>Authorization: Bearer eyJhbGciOiJSUzI1NiIs...</code></pre>

<h3>Error responses</h3>
<table>
  <thead>
    <tr><th>Status</th><th>Body</th><th>Cause</th></tr>
  </thead>
  <tbody>
    <tr><td><code>401</code></td><td><code>{"error": "Authorization header required"}</code></td><td>No <code>Authorization</code> header sent</td></tr>
    <tr><td><code>401</code></td><td><code>{"error": "Invalid token: ..."}</code></td><td>Token is expired, malformed, or signed by an untrusted issuer</td></tr>
  </tbody>
</table>

<h3>Example: authenticated request</h3>
<pre><code>curl -H "Authorization: Bearer eyJhbG..." \
     -H "Accept: application/json" \
     https://meine-piraten.de/tasks.json</code></pre>

<hr>

<h2>Tasks</h2>
<p>A task represents an actionable item assigned to an organizational entity and category.</p>

<h3>Endpoints</h3>
<table>
  <thead>
    <tr><th>Method</th><th>Path</th><th>Description</th></tr>
  </thead>
  <tbody>
    <tr><td>GET</td><td><code>/tasks.json</code></td><td>List all tasks</td></tr>
    <tr><td>GET</td><td><code>/tasks/:id.json</code></td><td>Get a single task</td></tr>
    <tr><td>POST</td><td><code>/tasks.json</code></td><td>Create a task</td></tr>
    <tr><td>PATCH/PUT</td><td><code>/tasks/:id.json</code></td><td>Update a task</td></tr>
    <tr><td>DELETE</td><td><code>/tasks/:id.json</code></td><td>Delete a task</td></tr>
  </tbody>
</table>

<h3>Request Parameters (create / update)</h3>
<p>Wrap parameters in a <code>task</code> key:</p>
<pre><code>{
  "task": {
    "title": "string (required, max 200 characters)",
    "description": "text (optional, max 2000 characters)",
    "completed": "boolean",
    "creator_name": "string",
    "time_needed_in_hours": "integer (optional)",
    "activity_points": "integer (optional)",
    "due_date": "date (YYYY-MM-DD, optional)",
    "urgent": "boolean (optional)",
    "category_id": "integer (required, foreign key)",
    "entity_id": "integer (required, foreign key)",
    "status": "string (optional, one of: open, claimed, done; default: open)",
    "assignee": "string (optional)"
  }
}</code></pre>

<h3>Response Example (single task)</h3>
<pre><code>{
  "id": 1,
  "title": "Wahlkampfmaterial bestellen",
  "description": "Flyer und Plakate f√ºr den Wahlkampf bestellen",
  "completed": false,
  "creator_name": "Max Mustermann",
  "time_needed_in_hours": 2,
  "due_date": "2025-06-01",
  "urgent": true,
  "activity_points": 10,
  "category_id": 1,
  "entity_id": 1,
  "status": "open",
  "assignee": null,
  "created_at": "2025-05-04T12:00:00.000Z",
  "updated_at": "2025-05-04T12:00:00.000Z",
  "url": "https://meine-piraten.de/tasks/1.json"
}</code></pre>

<h3>Response Example (list)</h3>
<pre><code>[
  { "id": 1, "title": "...", ... },
  { "id": 2, "title": "...", ... }
]</code></pre>

<h3>Status Transitions</h3>
<p>Task status follows a strict state machine. Invalid transitions return <strong>422 Unprocessable Entity</strong>.</p>
<table>
  <thead>
    <tr><th>From</th><th>Allowed transitions</th></tr>
  </thead>
  <tbody>
    <tr><td><code>open</code></td><td><code>claimed</code></td></tr>
    <tr><td><code>claimed</code></td><td><code>done</code>, <code>open</code></td></tr>
    <tr><td><code>done</code></td><td><em>(none &mdash; terminal state)</em></td></tr>
  </tbody>
</table>
<p>A task cannot go directly from <code>open</code> to <code>done</code>; it must first be <code>claimed</code>.</p>

<hr>

<h2>Comments</h2>
<p>Comments are nested under tasks. Each comment belongs to a task.</p>

<h3>Endpoints</h3>
<table>
  <thead>
    <tr><th>Method</th><th>Path</th><th>Description</th></tr>
  </thead>
  <tbody>
    <tr><td>GET</td><td><code>/tasks/:task_id/comments.json</code></td><td>List comments for a task</td></tr>
    <tr><td>POST</td><td><code>/tasks/:task_id/comments.json</code></td><td>Create a comment on a task</td></tr>
    <tr><td>DELETE</td><td><code>/tasks/:task_id/comments/:id.json</code></td><td>Delete a comment</td></tr>
  </tbody>
</table>

<h3>Request Parameters (create)</h3>
<p>Wrap parameters in a <code>comment</code> key:</p>
<pre><code>{
  "comment": {
    "author_name": "string",
    "text": "string (required)"
  }
}</code></pre>

<h3>Response Example (single comment)</h3>
<pre><code>{
  "id": 1,
  "task_id": 1,
  "author_name": "Max Mustermann",
  "text": "Flyer sind bestellt.",
  "created_at": "2025-05-04T12:30:00.000Z",
  "updated_at": "2025-05-04T12:30:00.000Z",
  "url": "https://meine-piraten.de/tasks/1/comments/1.json"
}</code></pre>

<h3>Response Example (list)</h3>
<pre><code>[
  { "id": 1, "task_id": 1, "author_name": "...", "text": "...", ... },
  { "id": 2, "task_id": 1, "author_name": "...", "text": "...", ... }
]</code></pre>
